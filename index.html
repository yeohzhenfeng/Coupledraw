<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ’ æƒ…ä¾£æŠ½ç­¾ / éšæœºæŒ‘æˆ˜</title>
  <style>
    :root{
      --bg1:#0f172a;
      --bg2:#1f2937;
      --card: rgba(255,255,255,.08);
      --card2: rgba(255,255,255,.12);
      --stroke: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --pink:#ff4da6;
      --cyan:#4de3ff;
      --good:#46f59a;
      --warn:#ffcf4d;
      --bad:#ff5a5a;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --r: 18px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(255,77,166,.20), transparent 60%),
        radial-gradient(900px 700px at 80% 20%, rgba(77,227,255,.18), transparent 60%),
        radial-gradient(900px 700px at 60% 90%, rgba(70,245,154,.10), transparent 65%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }
    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:22px 16px 40px;
    }
    header{
      display:flex;
      gap:14px;
      align-items:flex-start;
      justify-content:space-between;
      margin-bottom:16px;
    }
    .title{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .title h1{
      margin:0;
      font-size:22px;
      letter-spacing:.3px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .title p{
      margin:0;
      color:var(--muted);
      font-size:13px;
      line-height:1.45;
    }
    .chiprow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }
    .chip{
      padding:8px 10px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      backdrop-filter: blur(10px);
    }
    .chip b{ color:var(--text); font-weight:650; }

    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:14px;
    }
    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
      header{ flex-direction:column; gap:12px; }
      .chiprow{ justify-content:flex-start; }
    }

    .card{
      background: var(--card);
      border:1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
    }
    .card .hd h2{
      margin:0;
      font-size:14px;
      letter-spacing:.2px;
      color:rgba(255,255,255,.88);
      display:flex;
      align-items:center;
      gap:8px;
    }
    .card .bd{ padding:14px; }

    .btnrow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    button{
      appearance:none;
      border:none;
      cursor:pointer;
      border-radius: 14px;
      padding:12px 14px;
      font-weight:700;
      font-size:14px;
      color:rgba(255,255,255,.92);
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.16);
      box-shadow: 0 10px 30px rgba(0,0,0,.20);
      transition: transform .12s ease, background .12s ease, border-color .12s ease, opacity .12s ease;
      user-select:none;
    }
    button:hover{ transform: translateY(-1px); background: rgba(255,255,255,.14); border-color: rgba(255,255,255,.22); }
    button:active{ transform: translateY(0px) scale(.99); }
    button[disabled]{ opacity:.5; cursor:not-allowed; }
    .primary{
      background: linear-gradient(135deg, rgba(255,77,166,.95), rgba(77,227,255,.80));
      border-color: rgba(255,255,255,.25);
      color: #0b1020;
      text-shadow: none;
    }
    .good{ background: rgba(70,245,154,.12); border-color: rgba(70,245,154,.28); }
    .warn{ background: rgba(255,207,77,.12); border-color: rgba(255,207,77,.28); }
    .bad{ background: rgba(255,90,90,.12); border-color: rgba(255,90,90,.28); }
    .mini{
      padding:10px 12px;
      font-size:13px;
      border-radius:12px;
    }

    .split{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 520px){
      .split{ grid-template-columns:1fr; }
    }

    label{
      display:flex;
      gap:10px;
      align-items:center;
      font-size:13px;
      color:var(--muted);
    }
    input[type="checkbox"]{
      width:18px; height:18px;
      accent-color: var(--pink);
    }
    input[type="number"], input[type="text"], textarea{
      width:100%;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.14);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      outline:none;
      font-size:13px;
    }
    textarea{
      min-height:140px;
      resize:vertical;
      line-height:1.5;
    }
    .hint{
      margin-top:8px;
      font-size:12px;
      color: rgba(255,255,255,.62);
      line-height:1.45;
    }

    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .row{
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
      padding:12px 12px;
      border-radius:14px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
    }
    .row .txt{
      display:flex;
      flex-direction:column;
      gap:6px;
      flex:1;
      min-width:0;
    }
    .row .txt .t{
      font-weight:750;
      font-size:14px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .row .txt .s{
      font-size:12px;
      color: rgba(255,255,255,.62);
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      padding:4px 8px;
      border-radius:999px;
    }
    .row .actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .hr{ height:1px; background: rgba(255,255,255,.10); margin:12px 0; }

    /* Modal */
    .modalMask{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index: 50;
    }
    .modal{
      width:min(720px, 96vw);
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.18);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(0,0,0,.18));
      backdrop-filter: blur(14px);
      box-shadow: 0 26px 90px rgba(0,0,0,.55);
      overflow:hidden;
      transform: translateY(6px) scale(.985);
      opacity:0;
      transition: transform .18s ease, opacity .18s ease;
    }
    .modal.show{
      transform: translateY(0) scale(1);
      opacity:1;
    }
    .modal .mhd{
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      background: rgba(255,255,255,.06);
      border-bottom:1px solid rgba(255,255,255,.12);
    }
    .modal .mhd .ttl{
      font-weight:850;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .modal .mbd{
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .big{
      font-size:22px;
      font-weight:900;
      line-height:1.25;
    }
    .sub{
      color: rgba(255,255,255,.70);
      font-size:13px;
      line-height:1.55;
    }
    .timer{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 12px;
      border-radius:16px;
      background: rgba(0,0,0,.20);
      border:1px solid rgba(255,255,255,.14);
    }
    .timer .left{
      display:flex; flex-direction:column; gap:4px;
    }
    .timer .left .k{ font-size:12px; color: rgba(255,255,255,.62); }
    .timer .left .v{ font-size:18px; font-weight:900; }
    .progress{
      height:10px;
      border-radius:999px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .progress > i{
      display:block;
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(255,77,166,.95), rgba(77,227,255,.85));
      border-radius:999px;
      transition: width .25s ease;
    }

    /* Confetti */
    .confetti{
      position:fixed;
      inset:0;
      pointer-events:none;
      overflow:hidden;
      z-index: 60;
    }
    .c{
      position:absolute;
      width:10px; height:14px;
      opacity:.95;
      border-radius:3px;
      transform: translateY(-20px) rotate(0deg);
      animation: fall linear forwards;
      filter: drop-shadow(0 10px 12px rgba(0,0,0,.25));
    }
    @keyframes fall{
      to{
        transform: translateY(calc(100vh + 40px)) rotate(720deg);
        opacity:1;
      }
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.18);
      backdrop-filter: blur(12px);
      color: rgba(255,255,255,.92);
      padding:10px 12px;
      border-radius: 14px;
      font-size:13px;
      box-shadow: 0 20px 70px rgba(0,0,0,.40);
      display:none;
      z-index: 70;
      max-width:min(720px, 92vw);
      text-align:center;
    }
    .mutedLink{
      color: rgba(255,255,255,.72);
      text-decoration: underline;
      text-decoration-color: rgba(255,255,255,.25);
      text-underline-offset: 3px;
      cursor:pointer;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>ğŸ’ æƒ…ä¾£æŠ½ç­¾ / éšæœºæŒ‘æˆ˜</h1>
        <p>
          æŠ½ä¸€ä¸ªæŒ‘æˆ˜å°±å»åšï¼šä¸é‡å¤ã€å¯å¯¼å…¥ã€å¯å€’è®¡æ—¶æŒ‘æˆ˜ã€åˆ·æ–°ä¹Ÿä¿ç•™ã€‚<br/>
          å°æç¤ºï¼šæƒ³æ›´åƒâ€œæ¸¸æˆâ€ä¸€ç‚¹å°±å¼€ã€ŒæŒ‘æˆ˜æ¨¡å¼ã€+ è®¾ä¸ªå€’è®¡æ—¶ã€‚
        </p>
      </div>
      <div class="chiprow">
        <div class="chip">ğŸ¯ å¾…æŠ½ï¼š<b id="statRemaining">0</b></div>
        <div class="chip">ğŸ“œ å·²æŠ½ï¼š<b id="statDrawn">0</b></div>
        <div class="chip">ğŸ”¥ è¿ç»­æŒ‘æˆ˜ï¼š<b id="statStreak">0</b></div>
      </div>
    </header>

    <div class="grid">
      <!-- Left: Draw + Pool -->
      <section class="card">
        <div class="hd">
          <h2>ğŸ² æŠ½ç­¾æ§åˆ¶å°</h2>
          <div class="btnrow">
            <button class="primary" id="btnDraw">æ¥ä¸€æŠ½ï¼</button>
            <button class="mini warn" id="btnUndo">æ’¤å›ä¸Šä¸€æŠ½</button>
            <button class="mini bad" id="btnReset">é‡ç½®å…¨éƒ¨</button>
          </div>
        </div>
        <div class="bd">
          <div class="split">
            <div>
              <label><input type="checkbox" id="onlyFromRemaining" checked />åªä»â€œæœªæŠ½è¿‡â€é‡ŒæŠ½ï¼ˆä¸é‡å¤ï¼‰</label>
              <div class="hint">å‹¾é€‰åï¼šæŠ½è¿‡çš„ä¸ä¼šå†å‡ºç°ï¼›å–æ¶ˆå‹¾é€‰ï¼šä¼šå…è®¸é‡å¤ï¼ˆæ›´é€‚åˆâ€œæ— é™æŒ‘æˆ˜â€ï¼‰ã€‚</div>
            </div>
            <div>
              <label><input type="checkbox" id="challengeMode" checked />æŒ‘æˆ˜æ¨¡å¼ï¼ˆå¸¦å€’è®¡æ—¶ï¼‰</label>
              <div class="hint">å¼€å¯åä¼šå¼¹å‡ºæŒ‘æˆ˜å¡ç‰‡ï¼Œå¯è®¾å€’è®¡æ—¶ï¼Œå®Œæˆåå¯è®°å½•â€œè¿ç»­æŒ‘æˆ˜â€ã€‚</div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="split">
            <div>
              <label>â±ï¸ å€’è®¡æ—¶ï¼ˆåˆ†é’Ÿï¼Œå¯é€‰ï¼‰</label>
              <input id="minutes" type="number" min="0" max="300" step="1" placeholder="ä¾‹å¦‚ï¼š30" />
              <div class="hint">å¡« 0 æˆ–ç•™ç©º = ä¸å€’è®¡æ—¶ã€‚æ¯”å¦‚è®¾ 30 åˆ†é’Ÿï¼šæŠ½åˆ°åä¸€èµ·å®ŒæˆæŒ‘æˆ˜ã€‚</div>
            </div>
            <div>
              <label>ğŸšï¸ æŠ½ç­¾åŠ¨ç”»é€Ÿåº¦</label>
              <input id="spinSpeed" type="number" min="6" max="30" step="1" value="14" />
              <div class="hint">æ•°å­—è¶Šå¤§è¶Šæ…¢ï¼ˆé»˜è®¤ 14ï¼‰ã€‚å¦‚æœä½ æƒ³æ›´åˆºæ¿€ï¼šè®¾ 10ï½12ã€‚</div>
            </div>
          </div>

          <div class="hr"></div>

          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
            <h2 style="margin:0; font-size:14px;">ğŸ§º æŒ‘æˆ˜æ± ï¼ˆå¯ç¼–è¾‘/å¯¼å…¥ï¼‰</h2>
            <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
              <button class="mini good" id="btnLoadDefault">åŠ è½½å†…ç½® 100 æ¡</button>
              <button class="mini" id="btnExport">å¯¼å‡ºåˆ—è¡¨</button>
            </div>
          </div>

          <div style="margin-top:10px;">
            <label>ğŸ“¥ æ‰¹é‡å¯¼å…¥ï¼ˆæ¯è¡Œä¸€æ¡ / CSV ä¹Ÿè¡Œï¼‰</label>
            <textarea id="importBox" placeholder="ç²˜è´´ä½ çš„æ¸…å•ï¼šä¸€è¡Œä¸€ä¸ªæŒ‘æˆ˜ï¼Œä¾‹å¦‚ï¼š
ä¸€èµ·å»çœ‹æ—¥å‡ºæ—¥è½
ä¸€èµ·åšæ™šé¤
ä¸€èµ·Kæ­Œ
ï¼ˆæ”¯æŒ CSVï¼Œç”¨é€—å·åˆ†éš”ä¹Ÿå¯ï¼‰"></textarea>
            <div class="btnrow" style="margin-top:10px;">
              <button class="good" id="btnImport">å¯¼å…¥åˆ°æŒ‘æˆ˜æ± </button>
              <button class="mini bad" id="btnClearPool">æ¸…ç©ºæŒ‘æˆ˜æ± </button>
            </div>
            <div class="hint">
              âœ… å¯¼å…¥è§„åˆ™ï¼šä¼šè‡ªåŠ¨å»ç©ºè¡Œã€å»é‡å¤ï¼ˆå®Œå…¨ç›¸åŒæ‰ç®—é‡å¤ï¼‰ã€‚<br/>
              âœ… å¯¼å…¥åä¼šç«‹å³ä¿å­˜åˆ°æœ¬æœºæµè§ˆå™¨ï¼ˆlocalStorageï¼‰ï¼Œåˆ·æ–°ä»ç„¶å­˜åœ¨ã€‚
            </div>
          </div>
        </div>
      </section>

      <!-- Right: History -->
      <aside class="card">
        <div class="hd">
          <h2>ğŸ“œ å†å²è®°å½•</h2>
          <div class="btnrow">
            <button class="mini bad" id="btnClearHistory">æ¸…ç©ºå†å²</button>
          </div>
        </div>
        <div class="bd">
          <div class="list" id="historyList"></div>
          <div class="hint" id="historyHint"></div>
        </div>
      </aside>
    </div>

    <div class="hr" style="margin-top:16px;"></div>
    <div style="color:rgba(255,255,255,.65); font-size:12px; line-height:1.55;">
      å°æŠ€å·§ï¼šä½ ä¹Ÿå¯ä»¥æŠŠâ€œæŒ‘æˆ˜æ± â€æ¢æˆä½ ä»¬è‡ªå·±çš„ä¸“å±æ¸…å•ï¼Œæ¯”å¦‚ã€Œæ¯å‘¨ä¸€æ¬¡å°çº¦ä¼šã€ã€Œä¸€èµ·å­¦ä¸€é“èœã€ç­‰ç­‰ã€‚<br/>
      å¦‚æœä½ æƒ³è¦â€œæŠ½åˆ°å°±ç”Ÿæˆæ‰“å¡å¡ç‰‡ + åˆ†äº«å›¾ç‰‡â€ï¼Œä¹Ÿå¯ä»¥ç»§ç»­åŠ åŠŸèƒ½ã€‚
    </div>
  </div>

  <!-- Modal -->
  <div class="modalMask" id="mask">
    <div class="modal" id="modal">
      <div class="mhd">
        <div class="ttl" id="modalTitle">ğŸ¯ æœ¬æ¬¡æŒ‘æˆ˜</div>
        <button class="mini" id="btnClose">å…³é—­</button>
      </div>
      <div class="mbd">
        <div class="big" id="pickedText">â€”</div>
        <div class="sub" id="pickedSub">â€”</div>

        <div id="timerBox" style="display:none;">
          <div class="timer">
            <div class="left">
              <div class="k">å€’è®¡æ—¶</div>
              <div class="v" id="timerText">00:00</div>
            </div>
            <div style="min-width:160px; width:45%;">
              <div class="progress"><i id="bar"></i></div>
              <div class="hint" id="timerHint" style="margin:8px 0 0;">æ—¶é—´åˆ°ä¼šæç¤ºä½ ä»¬æ”¶å°¾/æ‰“å¡ã€‚</div>
            </div>
          </div>
          <div class="btnrow" style="margin-top:10px;">
            <button class="mini warn" id="btnPause">æš‚åœ</button>
            <button class="mini" id="btnRestart">é‡æ¥</button>
          </div>
        </div>

        <div class="btnrow" style="margin-top:6px;">
          <button class="primary" id="btnDone">âœ… æŒ‘æˆ˜å®Œæˆï¼</button>
          <button class="mini" id="btnRedraw">ğŸ” å†æŠ½ä¸€æ¬¡</button>
          <button class="mini bad" id="btnDeleteFromPool">ğŸ—‘ï¸ ä»æŒ‘æˆ˜æ± ç§»é™¤</button>
        </div>

        <div class="hint">
          æƒ³æ›´åƒæ¸¸æˆï¼Ÿå¯ä»¥åœ¨æŒ‘æˆ˜å®ŒæˆååŠ ä¸€ä¸ªå°å¥–åŠ±ï¼šæ¯”å¦‚ â€œèµ¢å®¶ç‚¹ä¸€æ¯å¥¶èŒ¶â€ ğŸ˜„
        </div>
      </div>
    </div>
  </div>

  <div class="confetti" id="confetti"></div>
  <div class="toast" id="toast"></div>

  <script>
    /**********************
     * Storage helpers
     **********************/
    const KEY = "couple_lottery_v1";
    function loadState(){
      try{
        const raw = localStorage.getItem(KEY);
        if(!raw) return null;
        return JSON.parse(raw);
      }catch(e){ return null; }
    }
    function saveState(){
      localStorage.setItem(KEY, JSON.stringify(state));
      render();
    }

    /**********************
     * Default 100 items (from your list)
     **********************/
    const DEFAULT_100 = [
      "ä¸€èµ·çœ‹æ—¥å‡ºæ—¥è½","åœ¨å¨æˆ¿ä¸€èµ·åšæ™šé¤","é€›è¶…å¸‚ä¹°ä¹°ä¹°","åœ¨ä¸‹é›¨å¤©è¿½å‰§","å»çœ‹ä¸€åœºçˆ±æƒ…ç”µå½±","ä¸€èµ·åƒéº»è¾£ç«é”…","æ¯å¤©äº’é“æ—©æ™šå®‰","ç”¨ç›¸æœºè®°å½•å¯¹æ–¹çš„æ ·å­","ä¸€èµ·é€›èŠ±é¸Ÿå¸‚åœº","åšæƒ…ä¾£å¤´åƒ",
      "åä¸€æ¬¡æ‘©å¤©è½®","çœ‹ä¸€åœºæ¼”å”±ä¼š","æ‹ä¸€å¥—æƒ…ä¾£å†™çœŸ","ä¸€èµ·å †é›ªäºº","å»æµ·è¾¹å¹å¹é£","ä¸€èµ·æ”¾é£ç­","ä¸€èµ·æ•·é¢è†œæŠ¤è‚¤","ä½äº”æ˜Ÿçº§é…’åº—","æ´—å®Œæ¾¡äº’å¹å¤´å‘","æ¥ä¸€æ¬¡å½»å¤œé•¿è°ˆ",
      "å·æ‹å¯¹æ–¹æ¨¡æ ·","ä¸€èµ·å»åˆ’èˆ¹","åœ¨ç­‰çº¢ç»¿ç¯æ—¶ kiss","ä¸ºå¯¹æ–¹è®¾è®¡å‘å‹","ä¸€èµ·é€›å¯ºåº™ç¥ˆç¦","é›¨å¤©åŒæ’‘ä¸€æŠŠä¼","ä¸€èµ·é€›å®¶å±…åŸ","ä¸€èµ·æ³¡æ¸©æ³‰","ä½“éªŒä¸€æ¬¡ live house","è‡ªé©¾æ¸¸å»æ—…è¡Œ",
      "å»å°æ¸…å§å–é…’èŠå¤©","å»çœ‹ä¸€æ¬¡æµ·åº•ä¸–ç•Œ","ä¸€èµ·åšå®¶åŠ¡","åšä¸€æ¬¡ç”œå“è›‹ç³•","å…»ä¸€åªå® ç‰©","ä¸ºå¯¹æ–¹å‡†å¤‡ç”Ÿæ—¥æƒŠå–œ","ç©çœŸå¿ƒè¯å¤§å†’é™©","å»ä¸€è¶Ÿè¿ªå£«å°¼ä¹å›­","å–é†‰ä¸€æ¬¡","ä¸€èµ·çœ‹æ¨±èŠ±",
      "æ¥å¯¹æ–¹ä¸‹ç­","ä¸€èµ·å¥èº«å‡è‚¥","ä¸€èµ·æ»‘é›ª","ä¸€èµ·éœ²è¥æ­å¸ç¯·","åƒéå„åœ°å¥½åƒçš„","å»æ¼‚æµ","ä¸€èµ·ä½“éªŒå°„ç®­","ä¸€èµ·é€›èœå¸‚åœº","ç©å¯†å®¤é€ƒè„±","ç©åˆ†æ‰‹å¨æˆ¿æ¸¸æˆ",
      "ä¸€èµ·æ¡‘æ‹¿æ±—è’¸","çœ‹æœ›åŒæ–¹çš„çˆ¶æ¯","ä¸€èµ·è·¨å¹´","çºªå¿µæ—¥é€ç¤¼ç‰©","ä¸€èµ·åƒç»¿çš®ç«è½¦","ç»™å¯¹æ–¹æ­é…è¡£æœ","å»å¤©å®‰é—¨çœ‹å‡å›½æ——","ä¸€èµ·ç©å¡ä¸è½¦","ä¸€èµ·æŸ“å¤´å‘","ä¸€èµ·ä¹°å½©ç¥¨åˆ®åˆ®ä¹",
      "åŒåƒä¸€æ ¹å†°æ·‡æ·‹","ä¸€èµ·é€›å…¬å›­æ‹ç…§","ä¸€èµ·æ³¡è„š","ä¸€èµ·æ¸¸æˆå…æŠ“å¨ƒå¨ƒ","ä¸ºå¯¹æ–¹ç”»åƒ","ä¸€èµ·æ”¾å­”æ˜ç¯","åˆ¶ä½œæ‰‹å·¥é’±åŒ…","ä¸€èµ·ç©¿æƒ…ä¾£è£…é€›è¡—","å»æ°´æœå›­æ‘˜æ°´æœ","ä¸€èµ·é’“é±¼",
      "çœ‹ç«¥å¹´çœ‹è¿‡çš„åŠ¨ç”»ç‰‡","åˆ¶ä½œä¸¤äººç”µå­ç›¸å†Œ","ä¸€èµ·æ”¾å£°Kæ­Œ","ä¸€èµ·å‹é©¬è·¯","è®²ç¡å‰æ•…äº‹","ç»™ç”·æœ‹å‹åŒ–å¦†","ä¸€èµ·æŒ‘æˆ˜è¶£å‘³æ¸¸æˆ","é€›åŠ¨ç‰©å›­","åƒéå„ç§ç¾é£Ÿ","å®…å®¶æ²‰æµ¸å¼çœ‹ç”µå½±",
      "ä¸€èµ·æ·‹é›¨","æ¨¡ä»¿å¯¹æ–¹å°åŠ¨ä½œ","ä¸€èµ·å»åšç‰©é¦†","å¤œéª‘å•è½¦å…œé£","ä¸€èµ·éœ²è¥é‡é¤","å·å·ä¹°ä¸‹Taå–œæ¬¢çš„ä¸œè¥¿","å¸¸æŠŠâ€œçˆ±ä½ â€æŒ‚å˜´è¾¹","å†™ä¸€å°å‘Šç™½ä¿¡","ä¸€èµ·åšé™¶è‰º","ä¸€èµ·å»è‰åŸéª‘é©¬",
      "ä¸€èµ·å¾’æ­¥çˆ¬æ³°å±±","ä¸€èµ·åŸ¹å…»ä¸€é¡¹å…´è¶£çˆ±å¥½","åšä¸€æ¬¡çƒ­æ°”çƒ","ä¸€èµ·é€šå®µçœ‹çƒ","ä¸€èµ·æ‹¼ä¹é«˜","ä¸€èµ·ç§ä¸€æ£µæ¤ç‰©","æ´—å‡ºç…§ç‰‡è´´æ»¡æˆ¿é—´","ç»™å¯¹æ–¹åšä¾¿å½“","ä¸€èµ·è§„åˆ’å½¼æ­¤çš„æœªæ¥","ç™½å¤´å•è€åœ¨ä¸€èµ·ä¸€è¾ˆå­"
    ];

    /**********************
     * State
     **********************/
    const saved = loadState();
    const state = saved ?? {
      pool: [...DEFAULT_100],
      drawn: [],      // array of {text, ts}
      streak: 0,
      lastPick: null, // {text, ts}
      settings: {
        onlyFromRemaining: true,
        challengeMode: true,
        minutes: "",
        spinSpeed: 14
      }
    };

    /**********************
     * DOM
     **********************/
    const $ = (id)=>document.getElementById(id);

    const statRemaining = $("statRemaining");
    const statDrawn = $("statDrawn");
    const statStreak = $("statStreak");

    const btnDraw = $("btnDraw");
    const btnUndo = $("btnUndo");
    const btnReset = $("btnReset");
    const btnImport = $("btnImport");
    const btnLoadDefault = $("btnLoadDefault");
    const btnExport = $("btnExport");
    const btnClearPool = $("btnClearPool");
    const btnClearHistory = $("btnClearHistory");

    const onlyFromRemaining = $("onlyFromRemaining");
    const challengeMode = $("challengeMode");
    const minutes = $("minutes");
    const spinSpeed = $("spinSpeed");
    const importBox = $("importBox");

    const historyList = $("historyList");
    const historyHint = $("historyHint");

    // modal
    const mask = $("mask");
    const modal = $("modal");
    const btnClose = $("btnClose");
    const pickedText = $("pickedText");
    const pickedSub = $("pickedSub");
    const btnDone = $("btnDone");
    const btnRedraw = $("btnRedraw");
    const btnDeleteFromPool = $("btnDeleteFromPool");

    // timer UI
    const timerBox = $("timerBox");
    const timerText = $("timerText");
    const btnPause = $("btnPause");
    const btnRestart = $("btnRestart");
    const bar = $("bar");

    const confetti = $("confetti");
    const toast = $("toast");

    /**********************
     * Utility
     **********************/
    function nowTs(){ return Date.now(); }
    function fmtTime(ts){
      const d = new Date(ts);
      const pad = (n)=>String(n).padStart(2,"0");
      return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }
    function uniqClean(items){
      const out = [];
      const seen = new Set();
      for(const it of items){
        const t = (it ?? "").toString().trim();
        if(!t) continue;
        if(seen.has(t)) continue;
        seen.add(t);
        out.push(t);
      }
      return out;
    }
    function showToast(msg){
      toast.textContent = msg;
      toast.style.display = "block";
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=>toast.style.display="none", 2200);
    }
    function vibe(){
      if(navigator.vibrate) navigator.vibrate([35, 30, 35]);
    }
    function burstConfetti(){
      const colors = ["#ff4da6","#4de3ff","#46f59a","#ffcf4d","#ffffff"];
      const n = 90;
      const w = window.innerWidth;
      for(let i=0;i<n;i++){
        const el = document.createElement("div");
        el.className = "c";
        el.style.left = (Math.random()*w) + "px";
        el.style.top = (-30 - Math.random()*200) + "px";
        el.style.background = colors[Math.floor(Math.random()*colors.length)];
        el.style.animationDuration = (1.8 + Math.random()*1.6) + "s";
        el.style.animationDelay = (Math.random()*0.25) + "s";
        el.style.transform = `translateY(-20px) rotate(${Math.random()*180}deg)`;
        confetti.appendChild(el);
        setTimeout(()=>el.remove(), 3800);
      }
    }

    /**********************
     * Draw logic
     **********************/
    function remainingList(){
      const drawnSet = new Set(state.drawn.map(x=>x.text));
      return state.pool.filter(x => !drawnSet.has(x));
    }

    // "spin" animation: quickly show random candidates before final pick
    async function spinPick(candidates, speed){
      // speed: 6~30 (bigger = slower)
      const steps = 18 + Math.floor(Math.random()*10);
      let chosen = candidates[Math.floor(Math.random()*candidates.length)];
      for(let i=0;i<steps;i++){
        chosen = candidates[Math.floor(Math.random()*candidates.length)];
        pickedText.textContent = chosen;
        await new Promise(r=>setTimeout(r, Math.max(25, 420 - speed*18)));
      }
      return chosen;
    }

    /**********************
     * Timer
     **********************/
    let timer = {
      active:false,
      totalMs:0,
      leftMs:0,
      startAt:0,
      paused:false
    };
    let timerInterval = null;

    function stopTimer(){
      timer.active = false;
      timer.paused = false;
      clearInterval(timerInterval);
      timerInterval = null;
      timerBox.style.display = "none";
      bar.style.width = "0%";
    }
    function startTimer(minutesNum){
      const ms = Math.max(0, Math.floor(minutesNum*60*1000));
      if(ms <= 0){ stopTimer(); return; }
      timer.active = true;
      timer.totalMs = ms;
      timer.leftMs = ms;
      timer.startAt = Date.now();
      timer.paused = false;
      timerBox.style.display = "block";
      btnPause.textContent = "æš‚åœ";
      tickTimer(); // immediate
      clearInterval(timerInterval);
      timerInterval = setInterval(tickTimer, 250);
    }
    function tickTimer(){
      if(!timer.active) return;
      if(!timer.paused){
        const now = Date.now();
        const passed = now - timer.startAt;
        timer.leftMs = Math.max(0, timer.totalMs - passed);
      }
      const s = Math.ceil(timer.leftMs/1000);
      const mm = String(Math.floor(s/60)).padStart(2,"0");
      const ss = String(s%60).padStart(2,"0");
      timerText.textContent = `${mm}:${ss}`;
      const pct = timer.totalMs ? (1 - timer.leftMs/timer.totalMs)*100 : 0;
      bar.style.width = `${Math.min(100, Math.max(0, pct))}%`;

      if(timer.leftMs <= 0){
        clearInterval(timerInterval);
        timerInterval = null;
        timer.active = false;
        vibe();
        showToast("â° æ—¶é—´åˆ°å•¦ï¼ä½ ä»¬å¯ä»¥æ”¶å°¾/æ‰“å¡ï½");
        burstConfetti();
      }
    }
    function togglePause(){
      if(!timer.totalMs) return;
      timer.paused = !timer.paused;
      if(!timer.paused){
        // resume: reset startAt based on leftMs
        timer.startAt = Date.now() - (timer.totalMs - timer.leftMs);
        btnPause.textContent = "æš‚åœ";
      }else{
        btnPause.textContent = "ç»§ç»­";
      }
    }
    function restartTimer(){
      if(!timer.totalMs) return;
      startTimer(timer.totalMs/60000);
    }

    /**********************
     * Modal control
     **********************/
    function openModal(){
      mask.style.display = "flex";
      requestAnimationFrame(()=>modal.classList.add("show"));
    }
    function closeModal(){
      modal.classList.remove("show");
      setTimeout(()=>{ mask.style.display = "none"; }, 140);
      stopTimer();
    }

    /**********************
     * Actions
     **********************/
    btnDraw.addEventListener("click", async ()=>{
      const onlyRemain = onlyFromRemaining.checked;
      const candidates = onlyRemain ? remainingList() : [...state.pool];

      if(candidates.length === 0){
        showToast("âš ï¸ æ²¡æœ‰å¯æŠ½çš„å†…å®¹äº†ï¼Œç‚¹â€œé‡ç½®å…¨éƒ¨â€æˆ–å–æ¶ˆâ€œåªä»æœªæŠ½è¿‡é‡ŒæŠ½â€ã€‚");
        vibe();
        return;
      }

      // open modal first
      pickedText.textContent = "ğŸ² æŠ½ç­¾ä¸­â€¦";
      pickedSub.textContent = "æ­£åœ¨éšæœºæŒ‘é€‰ä¸€ä¸ªæŒ‘æˆ˜";
      timerBox.style.display = "none";
      openModal();

      const speed = clamp(parseInt(spinSpeed.value,10) || 14, 6, 30);
      const pick = await spinPick(candidates, speed);

      const ts = nowTs();
      state.lastPick = { text: pick, ts };

      // record to history when in non-repeat mode or when user wants history anyway
      state.drawn.unshift({ text: pick, ts });

      // update subtitle
      pickedText.textContent = pick;
      pickedSub.textContent = `æŠ½å–æ—¶é—´ï¼š${fmtTime(ts)} Â· å†å²è®°å½•å·²ä¿å­˜`;

      // Challenge mode timer
      if(challengeMode.checked){
        const m = parseFloat(minutes.value);
        if(!Number.isFinite(m) || m <= 0){
          stopTimer();
          timerBox.style.display = "none";
        }else{
          startTimer(m);
        }
      }else{
        stopTimer();
      }

      vibe();
      saveState();
    });

    btnDone.addEventListener("click", ()=>{
      // increment streak if lastPick exists
      if(state.lastPick?.text){
        state.streak = (state.streak || 0) + 1;
        saveState();
        burstConfetti();
        vibe();
        showToast(`âœ… å®Œæˆï¼è¿ç»­æŒ‘æˆ˜ +1ï¼ˆç°åœ¨ï¼š${state.streak}ï¼‰`);
      }else{
        showToast("å…ˆæŠ½ä¸€ä¸ªæŒ‘æˆ˜å†å®Œæˆå–”ï½");
      }
    });

    btnRedraw.addEventListener("click", ()=>{
      closeModal();
      setTimeout(()=>btnDraw.click(), 120);
    });

    btnDeleteFromPool.addEventListener("click", ()=>{
      const t = state.lastPick?.text;
      if(!t) return;
      state.pool = state.pool.filter(x=>x !== t);
      showToast("å·²ä»æŒ‘æˆ˜æ± ç§»é™¤è¿™ä¸€æ¡ã€‚");
      vibe();
      saveState();
    });

    btnClose.addEventListener("click", closeModal);
    mask.addEventListener("click", (e)=>{ if(e.target === mask) closeModal(); });

    btnPause.addEventListener("click", togglePause);
    btnRestart.addEventListener("click", restartTimer);

    btnUndo.addEventListener("click", ()=>{
      if(state.drawn.length === 0){
        showToast("æ²¡æœ‰å¯æ’¤å›çš„è®°å½•ã€‚");
        return;
      }
      const removed = state.drawn.shift();
      // If the undone one was lastPick, clear lastPick
      if(state.lastPick?.text === removed.text) state.lastPick = null;
      // Decrease streak slightly? è¿™é‡Œæˆ‘ä¸è‡ªåŠ¨å‡ streakï¼ˆæ›´åƒâ€œå®Œæˆæ•°â€ï¼‰ï¼Œä½ æƒ³å‡æˆ‘ä¹Ÿèƒ½æ”¹
      showToast("å·²æ’¤å›ä¸Šä¸€æŠ½ã€‚");
      vibe();
      saveState();
    });

    btnClearHistory.addEventListener("click", ()=>{
      state.drawn = [];
      state.lastPick = null;
      state.streak = 0;
      showToast("å†å²å·²æ¸…ç©ºï¼ˆè¿ç»­æŒ‘æˆ˜ä¹Ÿæ¸…é›¶ï¼‰ã€‚");
      vibe();
      saveState();
    });

    btnReset.addEventListener("click", ()=>{
      // reset drawn only, keep pool
      state.drawn = [];
      state.lastPick = null;
      state.streak = 0;
      showToast("å·²é‡ç½®ï¼šå†å²æ¸…ç©ºï¼Œå¾…æŠ½æ¢å¤ã€‚");
      vibe();
      saveState();
    });

    btnClearPool.addEventListener("click", ()=>{
      state.pool = [];
      showToast("æŒ‘æˆ˜æ± å·²æ¸…ç©ºã€‚ä½ å¯ä»¥ç²˜è´´å¯¼å…¥æ–°çš„æ¸…å•ã€‚");
      vibe();
      saveState();
    });

    btnLoadDefault.addEventListener("click", ()=>{
      state.pool = [...DEFAULT_100];
      showToast("å·²åŠ è½½å†…ç½® 100 æ¡æŒ‘æˆ˜ã€‚");
      vibe();
      saveState();
    });

    btnImport.addEventListener("click", ()=>{
      const text = importBox.value || "";
      const lines = text
        .replace(/\r/g,"")
        .split("\n")
        .flatMap(line => {
          // allow CSV separated by comma/Chinese comma/semicolon
          const parts = line.split(/[,ï¼Œ;ï¼›]/g);
          return parts.map(x=>x.trim()).filter(Boolean);
        });

      const merged = uniqClean([...(state.pool||[]), ...lines]);
      const added = merged.length - (state.pool?.length || 0);
      state.pool = merged;

      importBox.value = "";
      showToast(`å¯¼å…¥å®Œæˆï¼šæ–°å¢ ${Math.max(0, added)} æ¡ã€‚`);
      vibe();
      saveState();
    });

    btnExport.addEventListener("click", ()=>{
      const content = (state.pool || []).join("\n");
      const blob = new Blob([content], {type:"text/plain;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "couple_challenges.txt";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      showToast("å·²å¯¼å‡ºæŒ‘æˆ˜æ± åˆ° txt æ–‡ä»¶ã€‚");
    });

    onlyFromRemaining.addEventListener("change", ()=>{
      state.settings.onlyFromRemaining = onlyFromRemaining.checked;
      saveState();
    });
    challengeMode.addEventListener("change", ()=>{
      state.settings.challengeMode = challengeMode.checked;
      saveState();
    });
    minutes.addEventListener("input", ()=>{
      state.settings.minutes = minutes.value;
      saveState();
    });
    spinSpeed.addEventListener("input", ()=>{
      state.settings.spinSpeed = spinSpeed.value;
      saveState();
    });

    function clamp(n,min,max){ return Math.min(max, Math.max(min, n)); }

    /**********************
     * Render
     **********************/
    function renderHistory(){
      historyList.innerHTML = "";
      const h = state.drawn || [];
      if(h.length === 0){
        historyHint.innerHTML = `è¿˜æ²¡æœ‰è®°å½•ã€‚ç‚¹ <span class="mutedLink" id="hintDraw">æ¥ä¸€æŠ½ï¼</span> å¼€å§‹å§ï½`;
        setTimeout(()=>{
          const el = document.getElementById("hintDraw");
          if(el) el.onclick = ()=>btnDraw.click();
        },0);
        return;
      }
      historyHint.textContent = "";

      h.slice(0, 30).forEach((it, idx)=>{
        const row = document.createElement("div");
        row.className = "row";
        row.innerHTML = `
          <div class="txt">
            <div class="t">${escapeHtml(it.text)}</div>
            <div class="s">
              <span class="tag">ğŸ•’ ${escapeHtml(fmtTime(it.ts))}</span>
              <span class="tag">#${idx+1}</span>
            </div>
          </div>
          <div class="actions">
            <button class="mini" data-act="copy" data-i="${idx}">å¤åˆ¶</button>
          </div>
        `;
        historyList.appendChild(row);
      });

      // bind actions
      historyList.querySelectorAll("button[data-act='copy']").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const i = parseInt(btn.getAttribute("data-i"),10);
          const item = h[i];
          if(!item) return;
          try{
            await navigator.clipboard.writeText(item.text);
            showToast("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ âœ…");
          }catch{
            // fallback
            const ta = document.createElement("textarea");
            ta.value = item.text;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand("copy");
            ta.remove();
            showToast("å·²å¤åˆ¶ âœ…");
          }
          vibe();
        });
      });

      if(h.length > 30){
        const more = document.createElement("div");
        more.className = "hint";
        more.textContent = `åªæ˜¾ç¤ºæœ€è¿‘ 30 æ¡å†å²ï¼ˆå…± ${h.length} æ¡ï¼‰ã€‚`;
        historyList.appendChild(more);
      }
    }

    function renderStats(){
      const rem = remainingList().length;
      const drawn = (state.drawn || []).length;
      statRemaining.textContent = rem;
      statDrawn.textContent = drawn;
      statStreak.textContent = state.streak || 0;

      btnUndo.disabled = drawn === 0;
      btnDraw.disabled = (state.pool || []).length === 0;

      // keep settings in sync
      onlyFromRemaining.checked = !!state.settings.onlyFromRemaining;
      challengeMode.checked = !!state.settings.challengeMode;
      minutes.value = state.settings.minutes ?? "";
      spinSpeed.value = state.settings.spinSpeed ?? 14;
    }

    function render(){
      renderStats();
      renderHistory();
    }

    function escapeHtml(s){
      return (s ?? "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // initial render
    render();
    saveState(); // ensure structure exists

    // If user opens page first time, give a friendly toast
    if(!saved){
      setTimeout(()=>showToast("å·²åŠ è½½å†…ç½® 100 æ¡æŒ‘æˆ˜ï¼šç‚¹ã€Œæ¥ä¸€æŠ½ï¼ã€å¼€å§‹ ğŸ²"), 600);
    }
  </script>
</body>
</html>
